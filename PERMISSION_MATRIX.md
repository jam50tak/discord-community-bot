# 権限マトリックス - 設定者・実行者一覧

## 📋 機能別権限マトリックス

| 機能 | コマンド | 権限名 | 設定者 | 実行者 | 管理者限定 |
|------|---------|--------|--------|--------|------------|
| **基本使用** | ボット全般 | `use_bot` | 管理者 | 付与されたユーザー・ロール | ❌ |
| **詳細分析** | `/analyze` | `run_analysis` | 管理者 | 付与されたユーザー・ロール | ❌ |
| **クイック分析** | `/quick-analyze` | `quick_analyze` | 管理者 | 付与されたユーザー・ロール | ❌ |
| **相談機能** | `/consult` | `consult` | 管理者 | 付与されたユーザー・ロール | ❌ |
| **設定管理** | `/config ai, apikey, channels, prompt` | `manage_config` | - | 管理者のみ | ✅ |
| **権限管理** | `/config permissions` | `manage_permissions` | - | 管理者のみ | ✅ |
| **ヘルプ表示** | `/help` | `view_help` | 管理者 | 付与されたユーザー・ロール | ❌ |

## 👑 管理者の定義

管理者は以下のいずれかに該当するユーザー：
- ✅ サーバー所有者
- ✅ Discord「管理者」権限保持者
- ✅ Discord「サーバー管理」権限保持者
- ✅ 設定された管理者ロール保持者

## 🎯 権限設定の流れ

### 1. 権限を設定できる人
```
管理者のみ → 全ての権限設定を管理
```

### 2. 権限を実行できる人
```
管理者 → 常に全権限
↓
ユーザー個別権限（カスタム） → 既存権限を上書き
↓
ユーザー個別権限（継承） → ロール権限に追加
↓
ロール権限 → 所属ロールの権限
↓
デフォルト権限 → 全ユーザーの基本権限
```

## 📊 実行権限早見表

### 誰でも実行可能な機能
- **なし** （デフォルトはヘルプのみ）

### 権限付与が必要な機能
| 機能 | 推奨対象 | 設定コマンド例 |
|------|----------|----------------|
| **基本使用** | 一般メンバー | `/config permissions role-add role:@メンバー permissions:use_bot` |
| **分析実行** | モデレーター | `/config permissions role-add role:@モデレーター permissions:use_bot,run_analysis` |
| **クイック分析** | 定期チェック担当 | `/config permissions user-add user:@分析担当 permissions:quick_analyze` |
| **相談機能** | 上級モデレーター | `/config permissions role-add role:@上級モデレーター permissions:consult` |

### 管理者限定機能
| 機能 | 説明 | 理由 |
|------|------|------|
| **設定管理** | AI、APIキー、チャンネル、プロンプト設定 | セキュリティ上重要 |
| **権限管理** | ユーザー・ロール権限の変更 | 権限昇格の防止 |

## 🔐 セキュリティ原則

### 最小権限の原則
- ユーザーには必要最小限の権限のみ付与
- 不要になった権限は即座に削除

### 階層化された権限設計
```
管理者（全権限）
├── 上級モデレーター（相談 + 分析）
├── モデレーター（分析のみ）
├── 一般メンバー（基本使用のみ）
└── 未設定ユーザー（ヘルプのみ）
```

### 監査とモニタリング
- 権限変更は全てログに記録
- 定期的な権限設定の見直し
- 不正使用の監視

## 🚨 緊急時の対応

### 権限を間違えて設定した場合
```bash
# ロール権限の削除
/config permissions role-remove role:@対象ロール

# ユーザー権限の削除
/config permissions user-remove user:@対象ユーザー

# デフォルト権限のリセット
/config permissions default permissions:view_help
```

### 管理者が機能を使えない場合
- 管理者は常に全権限を持つため、権限設定とは無関係
- APIキーの設定やボット設定を確認
- Discord権限（管理者・サーバー管理）を確認

### 権限設定が分からなくなった場合
```bash
# 現在の設定を確認
/config permissions view

# 利用可能な権限一覧
/config permissions list-permissions
```